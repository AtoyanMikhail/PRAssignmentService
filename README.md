# PR Assignment Service

Микросервис для автоматического назначения ревьюеров на Pull Request'ы с HTTPS REST API.

## Обзор

Этот сервис автоматически назначает ревьюеров на Pull Request'ы из команды автора, управляет командами и активностью пользователей, а также предоставляет статистику. Сервис обеспечивает справедливое распределение нагрузки и предотвращает изменения ревьюеров после слияния PR.

## Возможности

- **Автоматическое назначение ревьюеров**: Умное назначение до 2 ревьюеров из команды автора (исключая автора)
- **Управление командами**: Создание и управление командами разработчиков
- **Управление пользователями**: Обработка активации/деактивации пользователей с автоматическим переназначением
- **Жизненный цикл PR**: Создание, слияние и отслеживание статуса PR
- **Статистика**: Отслеживание нагрузки ревьюеров и статистики назначений
- **Балансировка нагрузки**: Справедливое распределение нагрузки ревью

## Быстрый старт

### Предварительные требования

- Go 1.25+
- Docker и Docker Compose

### Установка

1. Клонируйте репозиторий:
```bash
git clone https://github.com/AtoyanMikhail/PRAssignmentService.git
cd PRassignmentService
```

2. Соберите проект:
```bash
docker-compose up
```

Это запустит:
- Базу данных PostgreSQL
- Применит миграции 
- Запустит сервер на https://localhost:8080
- Запустит swaggerUI на http://localhost:8081

## Разработка

### Структура проекта

```
├── cmd/api/              # Точка входа приложения
├── internal/
│   ├── api/              # HTTP обработчики и middleware
│   ├── config/           # Управление конфигурацией
│   ├── db/               # Сгенерированный SQL код (sqlc)
│   ├── logger/           # Структурированное логирование
│   ├── models/           # Доменные модели
│   ├── repository/       # Слой доступа к данным
│   └── service/          # Слой бизнес-логики
├── database/
│   ├── migrations/       # SQL миграции
│   ├── queries/          # SQL запросы для генерации кода
│   └── schema.dbml       # Схема базы данных
├── docs/
│   └── openapi.yaml      # Спецификация API
├── scripts/              # Вспомогательные скрипты
├── tests/                # Интеграционные и нагрузочные тесты
└── certs/                # TLS сертификаты
```

### Доступные команды

```bash
# Разработка
make install        # Установить зависимости
make build          # Собрать приложение
make run            # Собрать и запустить
make dev            # Запустить в режиме разработки
make clean          # Очистить артефакты сборки

# Тестирование
make test           # Запустить unit тесты
make test-e2e       # Запустить end-to-end тесты
make test-load      # Запустить нагрузочные тесты
make test-all       # Запустить все тесты

# База данных
make docker-up      # Запустить базу данных
make migrate-up     # Применить миграции
make migrate-down   # Откатить миграции

# Генерация кода
make sqlc           # Сгенерировать SQL код
make generate-api   # Сгенерировать API код из OpenAPI спецификации

# Качество кода
make lint           # Запустить линтеры
make certs          # Сгенерировать TLS сертификаты
```

### Конфигурация

Сервис конфигурируется через переменные окружения. Скопируйте `.env.example` в `.env` и настройте значения:

```bash
# База данных
DB_HOST=localhost
DB_PORT=5432
DB_USER=postgres
DB_PASSWORD=postgres
DB_NAME=pr_assignment

# Сервер
SERVER_HOST=localhost
SERVER_PORT=8080
SERVER_TLS_ENABLED=true
SERVER_TLS_CERT_FILE=certs/server.crt
SERVER_TLS_KEY_FILE=certs/server.key

# Логирование
LOG_LEVEL=info
LOG_FORMAT=json
```

### Настройки логирования

**LOG_LEVEL** - уровень детализации логов:
- `debug` - максимально подробные логи, включая отладочную информацию
- `info` - информационные сообщения (по умолчанию)
- `warn` / `warning` - предупреждения
- `error` - только ошибки
- `fatal` - только критические ошибки

**LOG_FORMAT** - формат вывода логов:
- `json` - структурированный JSON формат (рекомендуется для production)
- `console` - читаемый текстовый формат (удобен для разработки)


## Документация API

API полностью документирован в формате OpenAPI 3.0 (см. `docs/openapi.yaml`). После запуска сервиса доступно:

- Swagger UI: http://localhost:8081/swagger/


## Тестирование

### Unit тесты
```bash
make test
```

### End-to-End тесты
```bash
make test-e2e
```

### Нагрузочные тесты
```bash
make test-load
```

## Вопросы и сделанные предположения

- Как выбирать ревьюеров при наличии нескольких кандидатов?
- Случайный выбор с балансировкой нагрузки для обеспечения справедливого распределения. Простой случайный выбор предотвращает предвзятость, а балансировка нагрузки обеспечивает, что ни один ревьюер не будет перегружен

- Что делать, когда нет доступных ревьюеров?
- Разрешить создание PR с 0 ревьюерами, логировать предупреждение. Это лучше, чем замедлять команды невозможностью открыть PR.

- Когда заменять деактивированных пользователей на существующих PR?
- Немедленная замена при деактивации. Гарантирует активных ревьюеров на всех открытых PR

- Какую статистику следует отслеживать?
- Количество назначений, нагрузка на пользователя, статистика команд. Предоставляет понимание распределения ревью и емкости команды.

## Характеристики производительности

Результаты нагрузочного тестирования:
```
Users: 200, Teams: 20, PRs: 200
Target RPS: 10, Actual RPS: 9.94
Total time: 20.121422007s, Avg response: 31.331006ms
Min response: 21.101807ms, Max response: 56.668174ms
Success rate: 100.00%
```

  